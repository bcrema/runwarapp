name: Backend CI/CD

on:
  push:
    branches:
      - master
    paths:
      - 'backend/**'
      - '.github/workflows/backend-ci-cd.yml'

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: us-central1
  REPO_NAME: runwar
  SERVICE_NAME: runwar-backend
  IMAGE_NAME: runwar-backend
  DB_INSTANCE_NAME: runwar-db
  DB_CONNECTION_NAME: ${{ secrets.GCP_PROJECT_ID }}:us-central1:runwar-db
  DB_NAME: runwar
  DB_USER: runwar-user
  RUNWAR_SEED_ENABLED: true

jobs:
  # ============================================
  # CI - Test & Build
  # ============================================
  test:
    name: Test & Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run tests
        run: ./gradlew test --no-daemon

      - name: Generate test report
        run: ./gradlew jacocoTestReport --no-daemon

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: backend/build/reports/tests/test/
          retention-days: 7

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: backend/build/reports/jacoco/
          retention-days: 7

      - name: Build application
        run: ./gradlew build -x test --no-daemon

  # ============================================
  # CD - Build & Deploy to GCP Cloud Run
  # ============================================
  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: test
    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Google Cloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Validate Cloud SQL IAM access
        run: |
          gcloud sql instances describe ${{ env.DB_INSTANCE_NAME }} \
            --project ${{ env.PROJECT_ID }} \
            --format='value(connectionName)'

      - name: Start Cloud SQL Auth Proxy
        run: |
          curl -fsSL https://storage.googleapis.com/cloud-sql-connectors/cloud-sql-proxy/v2.19.0/cloud-sql-proxy.linux.amd64 -o cloud-sql-proxy
          chmod +x cloud-sql-proxy
          ./cloud-sql-proxy ${{ env.DB_CONNECTION_NAME }} --port 5432 > /tmp/cloud-sql-proxy.log 2>&1 &
          echo $! > /tmp/cloud-sql-proxy.pid

          for i in {1..30}; do
            if ! kill -0 "$(cat /tmp/cloud-sql-proxy.pid)" >/dev/null 2>&1; then
              echo "Cloud SQL Proxy process exited unexpectedly"
              cat /tmp/cloud-sql-proxy.log
              exit 1
            fi
            if (echo > /dev/tcp/127.0.0.1/5432) >/dev/null 2>&1; then
              echo "Cloud SQL Proxy is ready."
              break
            fi
            if [ "$i" -eq 30 ]; then
              echo "Cloud SQL Proxy failed to start"
              cat /tmp/cloud-sql-proxy.log
              exit 1
            fi
            sleep 1
          done

      - name: Run Flyway migrations
        timeout-minutes: 6
        run: |
          set -euo pipefail
          trap 'echo "Flyway migration failed. Cloud SQL Proxy logs:"; cat /tmp/cloud-sql-proxy.log' ERR

          docker run --rm --network host \
            -v "${{ github.workspace }}/backend/src/main/resources/db/migration:/flyway/sql" \
            flyway/flyway:10.20.1 \
            -url="jdbc:postgresql://127.0.0.1:5432/${{ env.DB_NAME }}" \
            -user="${{ env.DB_USER }}" \
            -password="${{ secrets.DB_PASSWORD }}" \
            -connectRetries=3 \
            -locations="filesystem:/flyway/sql" \
            migrate

      - name: Build Docker image
        run: |
          docker build \
            -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:latest \
            .

      - name: Push Docker image
        run: |
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:latest

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --allow-unauthenticated \
            --add-cloudsql-instances ${{ env.DB_CONNECTION_NAME }} \
            --set-env-vars "^@@^SPRING_PROFILES_ACTIVE=prod@@DATABASE_URL=jdbc:postgresql:///${{ env.DB_NAME }}?socketFactory=com.google.cloud.sql.postgres.SocketFactory&cloudSqlInstance=${{ env.DB_CONNECTION_NAME }}@@DATABASE_USER=${{ env.DB_USER }}@@DATABASE_PASSWORD=${{ secrets.DB_PASSWORD }}@@JWT_SECRET=${{ secrets.JWT_SECRET }}@@CORS_ORIGINS=https://www.ligarun.com,https://ligarun.com@@RUNWAR_SEED_ENABLED=true" \
            --cpu=1 \
            --memory=512Mi \
            --min-instances=0 \
            --max-instances=1

      - name: Get Backend URL
        run: |
          BACKEND_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --format 'value(status.url)')
          echo "ðŸš€ Backend deployed to: $BACKEND_URL"
