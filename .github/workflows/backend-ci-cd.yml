name: Backend CI/CD

on:
  push:
    branches:
      - master
    paths:
      - 'backend/**'
      - '.github/workflows/backend-ci-cd.yml'

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: us-central1
  REPO_NAME: runwar
  SERVICE_NAME: runwar-backend
  IMAGE_NAME: runwar-backend
  DB_INSTANCE_NAME: runwar-db
  DB_NAME: runwar
  DB_USER: runwar-user

jobs:
  # ============================================
  # CI - Test & Build
  # ============================================
  test:
    name: Test & Build
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run tests
        run: ./gradlew test --no-daemon

      - name: Generate test report
        run: ./gradlew jacocoTestReport --no-daemon

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: backend/build/reports/tests/test/
          retention-days: 7

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: backend/build/reports/jacoco/
          retention-days: 7

      - name: Build application
        run: ./gradlew build -x test --no-daemon

  # ============================================
  # CD - Build & Deploy to GCP Cloud Run
  # ============================================
  deploy:
    name: Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: test
    defaults:
      run:
        working-directory: backend

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Google Cloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Get Cloud SQL Connection Name
        id: cloudsql
        run: |
          CONNECTION_NAME=$(gcloud sql instances describe ${{ env.DB_INSTANCE_NAME }} --format="value(connectionName)")
          echo "connection_name=$CONNECTION_NAME" >> $GITHUB_OUTPUT

      - name: Build Docker image
        run: |
          docker build \
            -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:latest \
            .

      - name: Push Docker image
        run: |
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:latest

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ env.SERVICE_NAME }} \
            --image ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --allow-unauthenticated \
            --add-cloudsql-instances ${{ steps.cloudsql.outputs.connection_name }} \
            --set-env-vars "SPRING_PROFILES_ACTIVE=prod" \
            --set-env-vars "DATABASE_URL=jdbc:postgresql:///${{ env.DB_NAME }}?socketFactory=com.google.cloud.sql.postgres.SocketFactory&cloudSqlInstance=${{ steps.cloudsql.outputs.connection_name }}" \
            --set-env-vars "DATABASE_USER=${{ env.DB_USER }}" \
            --set-env-vars "DATABASE_PASSWORD=${{ secrets.DB_PASSWORD }}" \
            --set-env-vars "JWT_SECRET=${{ secrets.JWT_SECRET }}" \
            --set-env-vars "CORS_ORIGINS=https://www.ligarun.com,https://ligarun.com" \
            --cpu=1 \
            --memory=512Mi \
            --min-instances=0 \
            --max-instances=1

      - name: Get Backend URL
        run: |
          BACKEND_URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --platform managed \
            --region ${{ env.REGION }} \
            --format 'value(status.url)')
          echo "ðŸš€ Backend deployed to: $BACKEND_URL"
